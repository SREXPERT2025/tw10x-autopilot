<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TW10X - TON Lottery</title>
    <style>
        :root { --main: #0098EA; --bg: #050505; --card: #111; --text: #eee; --gray: #666; }
        body { background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 0; line-height: 1.5; }
        a { text-decoration: none; color: inherit; transition: 0.2s; }
        
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        header { display: flex; justify-content: space-between; align-items: center; padding: 20px 0; }
        .logo { font-weight: 900; font-size: 24px; letter-spacing: -1px; background: linear-gradient(45deg, #0098EA, #00F0FF); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .hero { text-align: center; padding: 60px 0; }
        h1 { font-size: 42px; margin: 0 0 10px 0; font-weight: 800; }
        .subtitle { color: var(--gray); font-size: 18px; margin-bottom: 40px; }
        
        .prize-card { background: linear-gradient(180deg, #1a1a1a 0%, #0a0a0a 100%); border: 1px solid #333; border-radius: 24px; padding: 40px; margin: 0 auto; max-width: 400px; box-shadow: 0 10px 40px rgba(0, 152, 234, 0.1); }
        .prize-label { color: var(--main); text-transform: uppercase; font-size: 12px; font-weight: bold; letter-spacing: 2px; }
        .prize-amount { font-size: 56px; font-weight: 800; margin: 10px 0; line-height: 1; }
        .timer { color: var(--gray); font-variant-numeric: tabular-nums; font-size: 16px; margin-top: 10px; }
        
        .btn-play { display: inline-block; background: var(--main); color: #fff; font-weight: bold; padding: 18px 40px; border-radius: 100px; font-size: 18px; margin-top: 30px; box-shadow: 0 4px 20px rgba(0, 152, 234, 0.4); transform: translateY(0); }
        .btn-play:hover { transform: translateY(-2px); box-shadow: 0 6px 25px rgba(0, 152, 234, 0.6); }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-top: 60px; }
        .stat-card { background: var(--card); padding: 20px; border-radius: 16px; border: 1px solid #222; text-align: center; }
        .stat-val { font-size: 20px; font-weight: bold; color: #fff; }
        .stat-lbl { font-size: 11px; color: var(--gray); text-transform: uppercase; letter-spacing: 1px; margin-top: 5px; }
        
        .history-section { margin-top: 80px; }
        h3 { border-bottom: 1px solid #222; padding-bottom: 15px; margin-bottom: 20px; color: var(--gray); font-size: 14px; text-transform: uppercase; }
        .history-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .history-table th { text-align: left; color: var(--gray); font-weight: normal; padding: 10px; }
        .history-table td { padding: 15px 10px; border-bottom: 1px solid #1a1a1a; }
        .history-table tr:last-child td { border: none; }
        .tx-link { color: var(--main); opacity: 0.7; }
        .tx-link:hover { opacity: 1; text-decoration: underline; }

        footer { margin-top: 80px; border-top: 1px solid #222; padding-top: 40px; text-align: center; color: #444; font-size: 13px; }
        .socials { margin-bottom: 20px; }
        .socials a { margin: 0 10px; color: var(--gray); }
        .socials a:hover { color: #fff; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="logo">TW10X</div>
        <div class="socials" style="margin:0">
            <a href="https://t.me/tw10x" target="_blank">Channel</a>
        </div>
    </header>

    <div class="hero">
        <h1>Fair TON Lottery</h1>
        <div class="subtitle">Provably fair. Fully automated. Instant payouts.</div>
        
        <div class="prize-card">
            <div class="prize-label">Current Prize Pool</div>
            <div class="prize-amount" id="prize">...</div>
            <div class="timer" id="timer">Loading...</div>
            <a href="https://t.me/tw10x_official_bot" class="btn-play">PLAY IN TELEGRAM</a>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-val" id="jackpot">-</div>
            <div class="stat-lbl">Mega Jackpot</div>
        </div>
        <div class="stat-card">
            <div class="stat-val" id="holder">-</div>
            <div class="stat-lbl">Holder Drop</div>
        </div>
        <div class="stat-card">
            <div class="stat-val" id="treasury">-</div>
            <div class="stat-lbl">Treasury</div>
        </div>
        <div class="stat-card">
            <div class="stat-val" id="dev">-</div>
            <div class="stat-lbl">Dev Fund</div>
        </div>
    </div>

    <div class="history-section">
        <h3>Recent Winners</h3>
        <table class="history-table">
            <thead>
                <tr>
                    <th>Round</th>
                    <th>Date</th>
                    <th>Winner</th>
                    <th>Prize</th>
                    <th>Proof</th>
                </tr>
            </thead>
            <tbody id="history-rows">
                <tr><td colspan="5" style="text-align:center; color:#444">Loading...</td></tr>
            </tbody>
        </table>
    </div>

    <footer>
        <div class="socials">
            <a href="https://t.me/tw10x_official_bot" target="_blank">Bot</a>
            <a href="https://t.me/tw10x" target="_blank">Channel</a>
            <a href="https://tonviewer.com/EQCOaDls2_jUvqMOVdShynh4tbjZTwczd1Fj0P0PZpBhgYxd" target="_blank">Smart Contract</a>
        </div>
        &copy; 2026 TW10X. Built on TON.
    </footer>
</div>

<script>
    const API_OVERVIEW = '/api/public/overview';
    const API_ROUNDS = '/api/public/rounds';
    const fmt = (n) => n ? n.toLocaleString('en-US', {maximumFractionDigits: 1}) : "0";
    
    // FIX #1: Global variable for interval to prevent leaks
    let timerInterval = null;

    async function loadData() {
        try {
            // 1. Overview & Balances
            let res = await fetch(API_OVERVIEW);
            if (!res.ok) return;

            let data = await res.json();
            
            // FIX #2: Null-Guard (Crash protection)
            if (!data || !data.balances) {
                console.warn("API returned empty data");
                return;
            }
            
            // Update DOM
            document.getElementById('prize').innerText = fmt(data.balances.prize) + " TON";
            document.getElementById('jackpot').innerText = fmt(data.balances.jackpot);
            document.getElementById('holder').innerText = fmt(data.balances.holder);
            document.getElementById('treasury').innerText = fmt(data.balances.treasury);
            document.getElementById('dev').innerText = fmt(data.balances.dev);
            
            // Timer (Safe Start)
            startTimer(data.round_end_ts);

            // 2. Rounds History
            let resR = await fetch(API_ROUNDS);
            if (resR.ok) {
                let dataR = await resR.json();
                renderHistory(dataR.rounds);
            }

        } catch(e) {
            console.error("API Error:", e);
        }
    }

    function startTimer(endTs) {
        // FIX #1: Clear previous interval
        if (timerInterval) clearInterval(timerInterval);

        const el = document.getElementById('timer');
        
        // Initial run
        updateTimerUI(endTs, el);

        timerInterval = setInterval(() => {
            updateTimerUI(endTs, el);
        }, 1000);
    }

    function updateTimerUI(endTs, el) {
        let now = Math.floor(Date.now() / 1000);
        let diff = endTs - now;
        
        if (diff <= 0) {
            el.innerText = "Round Ending...";
            // Don't clear interval here to allow auto-restart detection if API updates
            return;
        }
        
        let d = Math.floor(diff / 86400);
        let h = Math.floor((diff % 86400) / 3600);
        let m = Math.floor((diff % 3600) / 60);
        let s = diff % 60;
        
        el.innerText = `Ends in: ${d}d ${h}h ${m}m ${s}s`;
    }

    function renderHistory(rounds) {
        const tbody = document.getElementById('history-rows');
        if (!rounds || rounds.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#444">No finished rounds yet</td></tr>';
            return;
        }
        
        let html = '';
        rounds.forEach(r => {
            let date = new Date(r.date * 1000).toLocaleDateString();
            html += `
                <tr>
                    <td>#${r.id}</td>
                    <td>${date}</td>
                    <td>${r.winner}</td>
                    <td style="color:#0098EA; font-weight:bold">${fmt(r.prize)} TON</td>
                    <td><a href="https://tonviewer.com/transaction/${r.tx}" target="_blank" class="tx-link">View TX</a></td>
                </tr>
            `;
        });
        tbody.innerHTML = html;
    }

    // Initial Load
    loadData();

    // Recommendation #4: Auto-refresh every 30s (Keeps data live)
    setInterval(loadData, 30000);
</script>

</body>
</html>
