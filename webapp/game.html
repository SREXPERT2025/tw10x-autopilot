<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>TW10X Game</title>

<!-- RELEASE v9.0 (Pure Address Payload) -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>

<style>
/* üé® THEME & RESET */
:root {
--main-color: #0098EA;
--accent-grad: linear-gradient(135deg, #0098EA 0%, #006499 100%);
--bg-color: #000000;
--card-bg: #1c1c1e;
--text-sec: #8e8e93;
--success: #34c759;
--danger: #ff453a;
--warn: #ff9f0a;
--muted-border: rgba(255,255,255,0.08);
--muted-border-2: rgba(255,255,255,0.12);
--modal-overlay: rgba(0,0,0,0.72);
}

* { box-sizing: border-box; }

body {
font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', Roboto, sans-serif;
background-color: var(--tg-theme-bg-color, var(--bg-color));
color: var(--tg-theme-text-color, #ffffff);
margin: 0;
padding: 0;
display: flex;
flex-direction: column;
height: 100vh;
-webkit-font-smoothing: antialiased;
text-rendering: optimizeLegibility;
}

a { color: #4facfe; text-decoration: none; }
a:active { opacity: 0.8; }

/* üß© LAYOUT */
.content {
flex: 1;
overflow-y: auto;
padding: 16px;
padding-bottom: 110px;
}
.hidden { display: none !important; }

/* typography */
.header {
text-align: center;
margin-bottom: 24px;
margin-top: 10px;
}
h1 {
margin: 0;
font-size: 32px;
font-weight: 800;
letter-spacing: -0.5px;
}
.subtitle {
color: var(--text-sec);
font-size: 13px;
margin-top: 4px;
font-weight: 500;
}

/* üÉè CARDS */
.card {
background: var(--card-bg);
border-radius: 20px;
padding: 20px;
margin-bottom: 16px;
box-shadow: 0 4px 20px rgba(0,0,0,0.3);
border: 1px solid rgba(255,255,255,0.05);
}
.card.highlight {
background: radial-gradient(circle at top right, #2a2a2c, #1c1c1e);
border: 1px solid rgba(0, 152, 234, 0.3);
box-shadow: 0 0 30px rgba(0, 152, 234, 0.1);
}

.stat-row {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 12px;
font-size: 15px;
gap: 12px;
}
.stat-row:last-child { margin-bottom: 0; }

.stat-val { font-weight: 600; }

.big-val {
font-size: 42px;
color: var(--main-color);
font-weight: 800;
display: block;
margin: 10px 0;
letter-spacing: -1px;
text-shadow: 0 0 20px rgba(0, 152, 234, 0.25);
}

.timer {
font-family: 'SF Mono', 'Courier New', monospace;
font-size: 16px;
color: var(--warn);
font-weight: 600;
background: rgba(255, 159, 10, 0.10);
padding: 6px 12px;
border-radius: 8px;
display: inline-block;
border: 1px solid rgba(255, 159, 10, 0.10);
}

/* üîò BUTTONS */
.btn {
background: var(--main-color);
color: white;
border: none;
padding: 18px;
border-radius: 16px;
font-size: 17px;
font-weight: 700;
cursor: pointer;
width: 100%;
transition: transform 0.1s, opacity 0.2s;
display: flex;
justify-content: center;
align-items: center;
box-shadow: 0 8px 25px rgba(0, 152, 234, 0.3);
}
.btn:active { transform: scale(0.96); }
.btn:disabled {
opacity: 0.6;
background: #333;
cursor: not-allowed;
box-shadow: none;
}
.btn-outline {
background: transparent;
border: 2px solid rgba(255,255,255,0.10);
color: var(--main-color);
box-shadow: none;
margin-top: 12px;
}
.btn-reset {
background: transparent;
border: 1px solid var(--danger);
color: var(--danger);
font-size: 10px;
padding: 8px;
margin-top: 15px;
width: 100%;
border-radius: 8px;
opacity: 0.7;
}
.btn-mini {
display: inline-flex;
align-items: center;
justify-content: center;
gap: 8px;
border: 1px solid var(--muted-border-2);
background: rgba(255,255,255,0.04);
color: #fff;
padding: 10px 12px;
border-radius: 12px;
font-size: 13px;
font-weight: 600;
cursor: pointer;
}
.btn-mini:active { transform: scale(0.98); }

/* ü¶¥ SKELETON LOADER */
.skeleton {
background: linear-gradient(90deg, #222 25%, #2a2a2a 50%, #222 75%);
background-size: 200% 100%;
animation: loading 1.5s infinite;
color: transparent !important;
border-radius: 10px;
}
@keyframes loading {
0% { background-position: 200% 0; }
100% { background-position: -200% 0; }
}

/* üì± BOTTOM NAV (Glassmorphism) */
.bottom-nav {
position: fixed;
bottom: 0;
left: 0;
width: 100%;
background: rgba(28, 28, 30, 0.85);
backdrop-filter: blur(20px);
-webkit-backdrop-filter: blur(20px);
border-top: 1px solid rgba(255,255,255,0.10);
display: flex;
justify-content: space-around;
padding: 10px 0;
padding-bottom: max(15px, env(safe-area-inset-bottom));
z-index: 100;
}
.nav-item {
color: var(--text-sec);
text-align: center;
font-size: 10px;
cursor: pointer;
flex: 1;
transition: color 0.2s;
}
.nav-item.active {
color: var(--main-color);
font-weight: 600;
}
.nav-icon {
font-size: 24px;
display: block;
margin-bottom: 4px;
}

/* MISC */
.ref-box {
background: #111;
padding: 14px;
border-radius: 12px;
margin: 15px 0;
border: 1px solid #333;
white-space: nowrap;
overflow-x: auto;
font-family: 'Courier New', monospace;
color: #4facfe;
}
.ticket-item {
border-bottom: 1px solid rgba(255,255,255,0.05);
padding: 14px 0;
display: flex;
justify-content: space-between;
font-size: 14px;
gap: 12px;
}
#ton-connect {
display: flex;
justify-content: center;
margin-bottom: 24px;
}
.status {
text-align: center;
margin-top: 15px;
font-size: 13px;
color: var(--success);
min-height: 20px;
font-weight: 500;
word-break: break-word;
}
.ref-badge {
    font-size: 11px;
    color: var(--success);
    background: rgba(52, 199, 89, 0.1);
    padding: 6px 12px;
    border-radius: 8px;
    display: none; /* Hidden by default */
    margin-bottom: 15px;
    text-align: center;
    border: 1px solid rgba(52, 199, 89, 0.3);
}

/* UX: Rules Link */
.legal-link {
text-align: center;
margin-top: 30px; 
font-size: 14px; 
color: #4facfe; 
font-weight: 700; 
cursor: pointer;
opacity: 0.9;
user-select: none;
transition: opacity 0.2s;
}
.legal-link:active { opacity: 0.7; }

/* ‚úÖ RULES MODAL */
.modal {
display: none;
position: fixed;
z-index: 1000;
left: 0; top: 0;
width: 100%;
height: 100%;
background-color: var(--modal-overlay);
backdrop-filter: blur(6px);
-webkit-backdrop-filter: blur(6px);
padding: 18px;
}

.modal-content {
background: rgba(28, 28, 30, 0.92);
border: 1px solid rgba(255,255,255,0.10);
border-radius: 24px;
width: min(720px, 100%);
margin: 8vh auto 0 auto;
padding: 18px 18px 16px 18px;
box-shadow: 0 18px 60px rgba(0,0,0,0.55);
max-height: 78vh;
overflow: hidden;
}

.modal-head {
display: flex;
align-items: center;
justify-content: space-between;
gap: 10px;
padding-bottom: 12px;
border-bottom: 1px solid rgba(255,255,255,0.08);
}

.modal-title {
font-size: 20px;
font-weight: 800;
letter-spacing: -0.2px;
margin: 0;
}

.modal-close {
width: 42px;
height: 42px;
border-radius: 14px;
border: 1px solid rgba(255,255,255,0.10);
background: rgba(255,255,255,0.06);
color: #fff;
cursor: pointer;
font-size: 22px;
line-height: 1;
display: inline-flex;
align-items: center;
justify-content: center;
}
.modal-close:active { transform: scale(0.98); }

.lang-switch {
display: flex;
gap: 10px;
padding-top: 14px;
padding-bottom: 12px;
}

.lang-btn {
flex: 0 0 auto;
padding: 10px 14px;
border-radius: 14px;
border: 1px solid rgba(255,255,255,0.12);
background: rgba(255,255,255,0.05);
color: #fff;
font-weight: 700;
font-size: 13px;
cursor: pointer;
min-width: 64px;
text-align: center;
user-select: none;
}

.lang-btn.active {
background: rgba(0, 152, 234, 0.22);
border-color: rgba(0, 152, 234, 0.35);
color: #fff;
}

.modal-body {
overflow-y: auto;
max-height: calc(78vh - 120px);
padding-right: 6px;
}
.modal-body::-webkit-scrollbar { width: 6px; }
.modal-body::-webkit-scrollbar-thumb {
background: rgba(255,255,255,0.15);
border-radius: 10px;
}

.rules-card {
background: rgba(255,255,255,0.04);
border: 1px solid rgba(255,255,255,0.08);
border-radius: 18px;
padding: 14px;
margin-bottom: 12px;
}
.rules-h {
margin: 0 0 10px 0;
font-size: 16px;
font-weight: 800;
letter-spacing: -0.2px;
}
.rules-p {
margin: 0;
font-size: 14px;
line-height: 1.55;
color: rgba(255,255,255,0.90);
}
.rules-ul {
margin: 8px 0 0 18px;
padding: 0;
color: rgba(255,255,255,0.92);
font-size: 14px;
line-height: 1.55;
}
.rules-kv {
display: grid;
grid-template-columns: 1fr;
gap: 10px;
margin-top: 10px;
}
.kv {
padding: 12px;
border-radius: 16px;
background: rgba(0,0,0,0.25);
border: 1px solid rgba(255,255,255,0.08);
}
.kv .k {
font-size: 11px;
letter-spacing: 0.8px;
text-transform: uppercase;
color: rgba(255,255,255,0.60);
margin-bottom: 6px;
font-weight: 800;
}
.kv .v {
font-size: 13px;
color: rgba(255,255,255,0.95);
word-break: break-all;
font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
}

.inline-actions {
display: flex;
gap: 10px;
flex-wrap: wrap;
margin-top: 10px;
}

.muted {
color: rgba(255,255,255,0.70);
font-size: 12px;
line-height: 1.45;
}
</style>
</head>

<body>
<!-- GAME TAB -->
<div id="tab-game" class="content">
<div class="header">
<h1>TW10X</h1>
<div class="subtitle">Fair On-Chain Game on TON</div>
</div>

<!-- STATS CARD -->
<div class="card highlight" style="text-align:center;">
<div style="font-size:11px; font-weight:700; color:var(--text-sec); letter-spacing:1px; text-transform:uppercase; margin-bottom:5px;">
CURRENT POOL
</div>

<div id="jackpot-display" class="big-val skeleton">Loading...</div>

<div style="margin-top:10px;">
<span id="timer-display" class="timer skeleton">--:--:--</span>
</div>

<div style="display:flex; justify-content:space-between; margin-top:20px; font-size:12px; color:var(--text-sec); border-top:1px solid rgba(255,255,255,0.1); padding-top:15px;">
<span id="total-users-display">Players: ...</span>
<span id="total-tickets-display">Tickets: ...</span>
</div>
</div>

<div class="card">
<div id="ton-connect"></div>
<!-- üî• REF BADGE -->
<div id="ref-badge" class="ref-badge">‚úÖ REFERRAL ACTIVE</div>
<div class="stat-row">
<span>Entry:</span><span class="stat-val">5 TON</span>
</div>
</div>

<button id="buyBtn" class="btn" disabled>‚è≥ Loading...</button>
<div id="status" class="status"></div>

<!-- üî• SAFETY BUTTON -->
<button onclick="hardResetWallet()" class="btn btn-reset">‚ö†Ô∏è HARD RESET WALLET</button>

<!-- RULES trigger -->
<div class="legal-link" onclick="openRulesModal()">üìú Rules & Disclaimer</div>
</div>

<!-- TICKETS TAB -->
<div id="tab-tickets" class="content hidden">
<div class="header"><h1>My Tickets</h1></div>

<div class="card">
<div class="stat-row">
<span>üéØ Your chance</span>
<span class="stat-val" id="win-chance-display">0%</span>
</div>
<div style="font-size:12px; color:var(--text-sec); margin-top:5px;">More tickets ‚Üí higher chance.</div>
</div>

<div id="tickets-list" class="card">
<p style="text-align:center; opacity:0.6;">Loading...</p>
</div>
</div>

<!-- REF TAB -->
<div id="tab-refs" class="content hidden">
<div class="header"><h1>Partners</h1></div>

<div class="card">
<div class="stat-row"><span>Invited</span><span class="stat-val" id="ref-count-display">0</span></div>
<div class="stat-row"><span>Earned</span><span class="stat-val" id="ref-earned-display">0 TON</span></div>
</div>

<div class="card" style="text-align:center;">
<p style="margin-bottom:8px;"><b>Get 10% (0.5 TON)</b></p>
<p style="font-size:13px; color:var(--text-sec); margin-top:0;">Instantly to your wallet for each friend.</p>

<div class="ref-box"><code id="ref-link">Loading...</code></div>
<button class="btn btn-outline" onclick="copyRef()">üìã Copy link</button>
</div>
</div>

<!-- Bottom nav -->
<div class="bottom-nav">
<div class="nav-item active" onclick="switchTab('game', this)"><span class="nav-icon">üé∞</span>Game</div>
<div class="nav-item" onclick="switchTab('tickets', this)"><span class="nav-icon">üéü</span>Tickets</div>
<div class="nav-item" onclick="switchTab('refs', this)"><span class="nav-icon">ü§ù</span>Ref</div>
</div>

<!-- RULES MODAL -->
<div id="rulesModal" class="modal" aria-hidden="true">
<div class="modal-content" role="dialog" aria-modal="true" aria-label="Rules">
<div class="modal-head">
<h2 class="modal-title">Rules</h2>
<button class="modal-close" onclick="closeRulesModal()" aria-label="Close">√ó</button>
</div>

<div class="lang-switch">
<div id="rulesLangRuBtn" class="lang-btn active" onclick="setRulesLang('ru')">RU</div>
<div id="rulesLangEnBtn" class="lang-btn" onclick="setRulesLang('en')">EN</div>
</div>

<div class="modal-body">
<!-- RU -->
<div id="rules-ru">
<div class="rules-card">
<div class="rules-h">–ß—Ç–æ —Ç–∞–∫–æ–µ TW10X</div>
<div class="rules-p">TW10X ‚Äî —ç—Ç–æ <b>on-chain –∏–≥—Ä–∞</b> –≤ –±–ª–æ–∫—á–µ–π–Ω–µ TON. –£—á–∞—Å—Ç–∏–µ —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–µ–π –≤ —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç.</div>
</div>
<div class="rules-card">
<div class="rules-h">–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç</div>
<ul class="rules-ul">
<li>–ü–æ–¥–∫–ª—é—á–∞–µ—Ç–µ –∫–æ—à–µ–ª—ë–∫ —á–µ—Ä–µ–∑ TonConnect.</li>
<li>–ù–∞–∂–∏–º–∞–µ—Ç–µ <b>Enter Game (5 TON)</b> –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç–µ 5 TON –≤ –∞–¥—Ä–µ—Å –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞.</li>
<li>–£—á–∞—Å—Ç–∏–µ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ –±–ª–æ–∫—á–µ–π–Ω.</li>
<li>–ü–æ –æ–∫–æ–Ω—á–∞–Ω–∏–∏ —Ä–∞—É–Ω–¥–∞ –ø–æ–±–µ–¥–∏—Ç–µ–ª—å –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ª–æ–≥–∏–∫–æ–π —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞.</li>
</ul>
</div>
<div class="rules-card">
<div class="rules-h">–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å</div>
<div class="rules-kv">
<div class="kv">
<div class="k">–ê–¥—Ä–µ—Å –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞</div>
<div class="v" id="contractAddressTextRu">‚Äî</div>
</div>
</div>
<div class="inline-actions">
<button class="btn-mini" onclick="copyContractAddress()">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
<button class="btn-mini" onclick="openContractExplorer()">üîé Explorer</button>
</div>
</div>
</div>

<!-- EN -->
<div id="rules-en" class="hidden">
<div class="rules-card">
<div class="rules-h">What is TW10X</div>
<div class="rules-p">TW10X is a <b>fair on-chain game</b> on the TON blockchain. Your entry is recorded by an on-chain transaction.</div>
</div>
<div class="rules-card">
<div class="rules-h">How it works</div>
<ul class="rules-ul">
<li>Connect your wallet via TonConnect.</li>
<li>Tap <b>Enter Game (5 TON)</b> and send 5 TON to the contract address.</li>
<li>Your entry is recorded on-chain.</li>
<li>Winner is selected by smart contract logic when round ends.</li>
</ul>
</div>
<div class="rules-card">
<div class="rules-h">Transparency</div>
<div class="rules-kv">
<div class="kv">
<div class="k">Contract address</div>
<div class="v" id="contractAddressTextEn">‚Äî</div>
</div>
</div>
<div class="inline-actions">
<button class="btn-mini" onclick="copyContractAddress()">üìã Copy</button>
<button class="btn-mini" onclick="openContractExplorer()">üîé Explorer</button>
</div>
</div>
</div>

</div>
</div>
</div>

<script>
// ==========================================
// üîí PRODUCTION LOGIC (v9.0 PURE ADDRESS)
// ==========================================
const CONTRACT_ADDRESS = "EQCOaDls2_jUvqMOVdShynh4tbjZTwczd1Fj0P0PZpBhgYxd";
const TICKET_PRICE = "5000000000";
const BOT_USERNAME = "tw10x_official_bot";

const tg = window.Telegram.WebApp;
tg.expand();

const userId = tg.initDataUnsafe?.user?.id;
let globalTotalTickets = 0;
let myTicketsCount = 0;
let userWallet = null;
let referrerAddress = null; // Store ref address

function sendAnalytics(event, extra = {}) {
    try {
        fetch('/api/analytics', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                event: event,
                user_id: window.Telegram?.WebApp?.initDataUnsafe?.user?.id || null,
                wallet: window.userWallet || null,
                ts: Date.now(),
                extra: extra
            })
        });
    } catch (e) {}
}

function switchTab(tabName, el) {
sendAnalytics('switch_tab', { tab: tabName });
document.querySelectorAll('.content').forEach(d => d.classList.add('hidden'));
document.getElementById('tab-' + tabName).classList.remove('hidden');
document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
if (el) el.classList.add('active');
if (tabName === 'tickets') loadTickets();
if (tabName === 'refs') { loadRefInfo(); loadRefStats(); }
}

const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
manifestUrl: 'https://tw10x.app/tonconnect-manifest.json',
buttonRootId: 'ton-connect'
});

async function hardResetWallet() {
    try { await tonConnectUI.disconnect(); } catch(e){}
    window.location.reload();
}

window.onload = () => {
document.getElementById('buyBtn').innerText = "üéü ENTER GAME (5 TON)";
syncContractAddressInRules();
loadGlobalStats();
loadRefInfo();
setInterval(updateTimer, 1000);
setInterval(loadGlobalStats, 30000);
};

tonConnectUI.onStatusChange(wallet => {
if (wallet) {
userWallet = wallet.account.address;
sendAnalytics('connect_wallet');
document.getElementById('buyBtn').disabled = false;
checkReferral(); // üî• TRIGGER CHECK
if (userId) {
fetch('/api/save_wallet', {
method: 'POST',
headers: {'Content-Type': 'application/json'},
body: JSON.stringify({ user_id: userId, wallet: userWallet })
}).catch(console.error);
}
} else {
userWallet = null;
document.getElementById('buyBtn').disabled = true;
}
});

// üî• LAZY LOAD TONWEB (Only if Ref exists)
function loadTonWeb() {
    if (window.TonWeb) return;
    const script = document.createElement('script');
    script.src = "https://unpkg.com/tonweb@0.0.66/dist/tonweb.js";
    document.head.appendChild(script);
}

// üî• CHECK REFS
async function checkReferral() {
    if (!userId) return;
    try {
        let res = await fetch(`/api/referrer?user_id=${userId}`);
        let data = await res.json();
        
        if (data.ref_wallet && data.ref_wallet !== userWallet) {
            referrerAddress = data.ref_wallet;
            const badge = document.getElementById('ref-badge');
            badge.style.display = 'block';
            badge.innerText = `‚úÖ REF: ${data.ref_wallet.slice(0,4)}...${data.ref_wallet.slice(-4)}`;
            
            // Start loading library for payload generation
            loadTonWeb();
        }
    } catch(e) {}
}

// üî• BUILD PAYLOAD (PURE ADDRESS) v9.0
async function createPayload() {
    if (!referrerAddress || !window.TonWeb) return null;

    try {
        const TonWeb = window.TonWeb;
        const cell = new TonWeb.boc.Cell();
        
        // ‚ùå –£–ë–ò–†–ê–ï–ú OpCode –∏ QueryID
        // cell.bits.writeUint(OP_CODE_REF, 32); 
        // cell.bits.writeUint(0, 64);
        
        // ‚úÖ –ü–ò–®–ï–ú –¢–û–õ–¨–ö–û –ê–î–†–ï–°
        const addr = new TonWeb.utils.Address(referrerAddress);
        cell.bits.writeAddress(addr);
        
        const bytes = await cell.toBoc();
        return TonWeb.utils.bytesToBase64(bytes);
    } catch (e) {
        console.error("Payload failed:", e);
        return null;
    }
}

document.getElementById('buyBtn').addEventListener('click', async () => {
    sendAnalytics('enter_game_click');
    if (!userWallet) return;
    document.getElementById('status').innerText = "‚è≥ Preparing...";
    
    // Try build payload (if ref exists)
    let payload = await createPayload();
    if (payload) {
        document.getElementById('status').innerText = "‚è≥ Building Ref TX...";
    }

    try {
        const txRequest = {
            validUntil: Math.floor(Date.now() / 1000) + 600, 
            messages: [{ 
                address: CONTRACT_ADDRESS, 
                amount: TICKET_PRICE,
                payload: payload // Will be null if no ref or error
            }]
        };
        await tonConnectUI.sendTransaction(txRequest);
        sendAnalytics('tx_success');
        document.getElementById('status').innerText = "üöÄ Success!";
        setTimeout(loadGlobalStats, 5000);
    } catch (e) {
        console.error(e);
        sendAnalytics('tx_cancel');
        document.getElementById('status').innerText = "Cancelled / Error";
    }
});

let roundEndTime = 0;

async function loadGlobalStats() {
try {
const res = await fetch('/api/global_stats', { cache: "no-store" });
const data = await res.json();
const jackpotEl = document.getElementById('jackpot-display');
jackpotEl.innerText = data.jackpot.toFixed(1) + " TON";
jackpotEl.classList.remove('skeleton');
roundEndTime = data.round_end;
const timerEl = document.getElementById('timer-display');
timerEl.classList.remove('skeleton');
document.getElementById('total-users-display').innerText = "Players: " + data.total_users;
document.getElementById('total-tickets-display').innerText = "Tickets: " + data.total_tickets;
globalTotalTickets = data.total_tickets;
} catch (e) {
console.error(e);
const jackpotEl = document.getElementById('jackpot-display');
if (jackpotEl && jackpotEl.classList.contains('skeleton')) {
jackpotEl.innerText = "‚Äî";
}
}
}

function updateTimer() {
if (!roundEndTime) return;
const now = Math.floor(Date.now() / 1000);
const diff = roundEndTime - now;
const el = document.getElementById('timer-display');
if (!el) return;
if (diff <= 0) {
el.innerText = "ROUND ENDING...";
return;
}
const days = Math.floor(diff / 86400);
const hours = Math.floor((diff % 86400) / 3600);
const minutes = Math.floor((diff % 3600) / 60);
const seconds = diff % 60;
let str = "";
if (days > 0) str += days + "d ";
str += [hours, minutes, seconds].map(v => v < 10 ? "0" + v : v).join(":");
el.innerText = str;
}

async function loadRefStats() {
if (!userId) return;
try {
const res = await fetch(`/api/ref_stats?user_id=${userId}`, { cache: "no-store" });
const data = await res.json();
document.getElementById('ref-count-display').innerText = data.invited;
document.getElementById('ref-earned-display').innerText = data.earned.toFixed(1) + " TON";
} catch (e) {}
}

async function loadTickets() {
const list = document.getElementById('tickets-list');
if (!list) return;
if (!userWallet) {
list.innerHTML = "<p style='text-align:center; opacity:0.7;'>Connect wallet first</p>";
return;
}
try {
const res = await fetch(`/api/user?address=${userWallet}`, { cache: "no-store" });
const data = await res.json();
if (!data.history || data.history.length === 0) {
list.innerHTML = "<p style='text-align:center; opacity:0.7;'>No entries yet</p>";
myTicketsCount = 0;
} else {
myTicketsCount = data.history.length;
let html = "";
data.history.forEach(t => {
html += `<div class="ticket-item">
<span style="font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Courier New', monospace; color:#4facfe">${t.hash}</span>
<span>${t.amount} TON</span>
</div>`;
});
list.innerHTML = html;
}
if (globalTotalTickets > 0) {
const chance = (myTicketsCount / globalTotalTickets) * 100;
document.getElementById('win-chance-display').innerText = chance.toFixed(2) + "%";
} else {
document.getElementById('win-chance-display').innerText = "0%";
}
} catch (e) {
console.error(e);
list.innerHTML = "<p style='text-align:center; opacity:0.7;'>Loading...</p>";
}
}

function loadRefInfo() {
if (userId) {
const link = `https://t.me/${BOT_USERNAME}?start=ref_${userId}`;
document.getElementById('ref-link').innerText = link;
} else {
document.getElementById('ref-link').innerText = "Open via Telegram";
}
}

function copyRef() {
const text = document.getElementById('ref-link').innerText;
navigator.clipboard.writeText(text).then(() => {
tg.showPopup({ message: "‚úÖ Copied", buttons: [{ type: "ok" }] });
}).catch(() => {});
}

let rulesLang = 'ru';

function openRulesModal() {
sendAnalytics('open_rules');
const m = document.getElementById('rulesModal');
if (!m) return;
m.style.display = "block";
m.setAttribute('aria-hidden', 'false');
try {
const lang = (tg?.initDataUnsafe?.user?.language_code || '').toLowerCase();
if (lang && lang !== 'ru' && lang !== 'ru-ru') setRulesLang('en');
else setRulesLang('ru');
} catch (e) {
setRulesLang('ru');
}
}

function closeRulesModal() {
const m = document.getElementById('rulesModal');
if (!m) return;
m.style.display = "none";
m.setAttribute('aria-hidden', 'true');
}

window.addEventListener('click', (event) => {
const m = document.getElementById('rulesModal');
if (!m) return;
if (event.target === m) closeRulesModal();
});

function setRulesLang(lang) {
rulesLang = (lang === 'en') ? 'en' : 'ru';
const ruBtn = document.getElementById('rulesLangRuBtn');
const enBtn = document.getElementById('rulesLangEnBtn');
const ru = document.getElementById('rules-ru');
const en = document.getElementById('rules-en');
if (!ruBtn || !enBtn || !ru || !en) return;
if (rulesLang === 'ru') {
ruBtn.classList.add('active');
enBtn.classList.remove('active');
ru.classList.remove('hidden');
en.classList.add('hidden');
} else {
enBtn.classList.add('active');
ruBtn.classList.remove('active');
en.classList.remove('hidden');
ru.classList.add('hidden');
}
}

function syncContractAddressInRules() {
const elRu = document.getElementById('contractAddressTextRu');
const elEn = document.getElementById('contractAddressTextEn');
if (elRu) elRu.innerText = CONTRACT_ADDRESS;
if (elEn) elEn.innerText = CONTRACT_ADDRESS;
}

function copyContractAddress() {
navigator.clipboard.writeText(CONTRACT_ADDRESS).then(() => {
tg.showPopup({ message: rulesLang === 'en' ? "‚úÖ Address copied" : "‚úÖ –ê–¥—Ä–µ—Å —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω", buttons: [{ type: "ok" }] });
}).catch(() => {});
}

function openContractExplorer() {
const url = `https://tonviewer.com/${CONTRACT_ADDRESS}`;
try { tg.openLink(url); } catch (e) { window.open(url, "_blank"); }
}
</script>
</body>
</html>
